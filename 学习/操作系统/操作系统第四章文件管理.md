# 文件管理
## 大纲
1. 文件系统基础
   1. 文件概念
   2. **逻辑结构（顺序、索引、索引顺序）**
   3. **目录结构（FAT）**
   4. 文件共享
   5. 文件保护（访问类型、访问控制）
2. 文件系统实现
   1. 层次结构
   2. 目录实现
   3. **文件实现**【核心】
3. 磁盘的组织管理
   1. 磁盘的结构【考点-算时间】
   2. 磁盘的调度算法【考点-4种算法】
   3. 磁盘的管理

## 1.文件系统基础
### 1.1文件的定义
文件是以计算机硬盘为载体存储在计算机上的信息集合。 在系统运行时，计算机以进程为基本单位进行资源的调度和分配。**而在用户进行输入输出时，则以文件为基本单位**。同时用户希望对文件进行各种各样的维护管理，因此就出现了**文件系统**。
### 1.2文件的属性
一般有名称、标识符、类型、位置、大小、保护、时间、日期、用户标识等。
### 1.3文件基本操作
创建、写、读、重定位、删除、截断。
### 1.4文件的逻辑结构【重要】
主要分为：
+ 无结构文件（流式文件）
  
  无结构文件是最简单的文件组织方式。无结构文件将数据按顺序组织成记录并积累保存，它是有序相关信息的集合，**以字节为单位**。由于没有结构，对记录的访问只能以穷举搜索的方式。

+ 有结构文件（按照记录的组织方式分类）
  + 顺序文件
    
    文件中的记录一个接一个地顺序排列，记录通常是定长的，可以顺序存储或以链表的方式存储，在访问时顺序搜索文件。顺序文件有以下两种结构：
    + 串结构：记录之间的顺序通常由存入时间决定。
    + 顺序结构：记录按照关键字顺序排列。
    
    顺序文件的优点：批量操作时在所有逻辑结构中效率最高。
    
    顺序文件的缺点：查找、修改、删除单个记录困难。

  + 索引文件

    对于定长记录文件要查找第i个记录时
    > Address_i = i * length

    对于可变长记录文件
    > Address_i = sigema(0~i-1) + i

    对于可变长记录文件只能顺序查找，开销较大，因此可以建立索引。其中索引表本身是定长记录文件（书本P213）。

  + 索引顺序文件

    将顺序文件分为若干组，为每组第一个记录建立索引。**查找次数为根号N次**。
  + 直接文件或散列文件

    对于给定记录的键值，根据散列函数直接计算物理地址，**没有顺序的特性**。
### 1.5目录结构
特点+目的：按名存取
#### 1.5.1文件控制块和索引节点
+ 文件控制块

  与进程管理一样，为实现目录管理，引入了**文件控制块**的数据结构。**FCB的有序集合就是文件目录，即一个FCB就是一个文件目录项。文件目录本身也是一个文件，称为目录文件。**

  文件控制块（FCB）主要包含以下信息：
  + 基本信息：如文件名、文件物理位置、文件逻辑结构、文件物理结构等。
  + 存取控制信息：存取权限等。
  + 使用信息：建立时间、修改时间等。
+ **索引节点**
  
  在检索目录文件的过程中，只用到了文件名，仅当匹配到了同名的目录项时才读取该文件的物理地址。也就是说，在检索目录时只用到了文件名，其他的信息不会使用也不会调入内存。因此，如UNIX等系统把文件名和文件描述信息分开，文件描述信息单独形成一个**索引节点**，文件目录的目录项只由文件名和指向对应索引节点的指针构成。
#### 1.5.2目录结构
我们先来看看一个目录有哪些操作：
+ 搜索
+ 创建文件
+ 删除文件
+ 显示目录
+ 修改目录

操作时，考虑一下几种目录结构：
1. 单级目录结构：只建立一张目录表，每个文件占一个目录项。缺点：查找速度慢、文件不允许重名、对多用户OS不友好。
2. 两级目录结构：将文件目录分为主文件目录（MFD）和用户文件目录（UFD）。主文件目录记录用户名等信息。
3. 多级目录结构：从根目录出发的路径称为绝对路径，文件名由'/'分隔。
4. 无环图目录结构：形成一个有向无环图，有利于文件共享，当一个用户删除文件时只删除对应的边，当所有的边都删掉的时候才删除该文件（类比python的垃圾处理机制）。
### 1.6文件共享
现代常用的两种文件共享方法有：
+ 基于索引节节点的共享方式（硬链接）：和上面的无环图目录结构相似，王道考研P218。
+ 利用符号链实现文件共享（软链接）：略。P218。
+ **总结**：硬链接就是使用FCB指针，每多一个硬链接，该文件的count计数器加一；软连接就是保存一份文件的绝对地址，count计数器等于链接时该文件的count值，当原文件删除时，软链接会找不到原文件。
### 1.7文件保护
文件保护通过**口令保护、加密保护、访问控制**等方式实现。其中前两者是防止文件被他人存取或窃取，后者用于控制用户对文件的访问方式。
+ 访问类型：保护可以从限制文件的访问类型出发，访问类型有如下几种：读、写、执行、添加、删除、列表清单（列出文件的名字和属性）。
+ 访问控制：最常用的方法是根据用户身份进行控制。例如：为每个文件增加一个访问控制列表（Access-Control List，ACL），以规定每个用户所允许的访问类型。

  一个精简ACL是：1.拥有者（创建者）2.组（可以共享文件的用户）3.其他（系统内的其他用户）。
## 2.文件系统实现
### *2.1文件系统层次结构【不怎么考】
1. 用户调用接口
2. 文件目录系统
3. 存取控制验证
4. 逻辑文件系统与文件信息缓冲区
5. 物理文件系统
6. 分配模块
7. 设备管理程序模块
### 2.2目录实现
1. 线性列表
   
   最简单的目录实现方法就是文件名+FCB指针
2. 哈希表
   
   速度快，但是要避免冲突。
### 2.3文件实现【核心】
1. 文件分配方式
   1. 连续分配：文件在磁盘上占有连续的块。这样的文件结构称为**顺序文件结构**，此时的物理文件称为**顺序文件**。目录形式一般是起始地址+文件长度。

      优点：简单，快速，寻道时间短。
      
      缺点：在插入删除时，文件的连续性不好控制，要做大量移动，**产生外部碎片**。
   2. 链接分配：采用离散的分配方式，消除外部碎片。当要分配盘块时，可以动态地分配，增删改方便。通过盘块上的链接指针将同属于一个文件的离散盘块链成链表。

      根据连接方式又可分为：
      + 隐式链接：每个物理块的最后一个字作为指针，指出后继块的物理地址。优点：空间利用率高，顺序存取效率高。缺点：随机存取效率太低，要访问第i个必须访问前i-1个。
      + 显式链接：为了克服链接文件存取效率低，提出文件映照技术，将链接文件中的链接字集中在一个结构中。既保持链接文件的优点，也克服其缺点。DOS、windows就采用这种技术。（文件分配表FAT，FAT本身很占空间）
   3. 索引分配
      链接分品牌解决了外部碎片的问题，但是不能有效支持直接访问。索引分配解决了这个问题，把每个文件的所有盘块好集中放在一起，构成了索引块（表）。既能顺序访问，又能随机存储，但是增加了访问索引表的次数。
      + 链接方案（单级索引）
      + 多层索引（访问速度：m级索引访问m+1次）
      + 混合索引（各种索引混合）
      + 三种方式的比较见王道考研P233
2. 文件存储空间管理
   
   实质上是对空闲块的组织和管理
   + 空闲表法：系统为所有空闲的连续空间建立一张空闲盘块表。第一个空闲块号+长度。
   + 空闲链表法
   + 位示图法：以二进制0/1表示无有。
   + 成组链接法

## 磁盘组织与管理
### 1.磁盘的结构
+ 盘片：上下两个记录面
+ 磁道：最外面是0磁道
+ 扇区
+ 扇段：磁盘信息的最基本单位。外道磁密度低，内道磁密度高。
+ 柱面：一串半径相等的磁道，在尽量不移动磁头的优先下，因此柱面优先。
+ 平均存取时间：找道时间+平均等待时间+数据传输时间。
### 2.磁盘调度算法
1. 先来先服务（FCFS）
2. 最短寻道时间优先（SSTF）：每次找最近的磁道，会造成饥饿（性能比FCFS好）
3. 扫描算法（SCAN）：电梯算法。
4. 循环扫描算法（CSCAN）：规定磁头单向移动。永远从上到下。
### 3.磁盘管理
1. 磁盘初始化
2. 引导快
3. 坏块
### 4.磁盘高速缓存
利用内存的一部分来做磁盘的高速缓存。
### 5.提高磁盘IO速度的方法
1. 提前读：在读当前块的同时，将下一块读入缓冲区。
2. 延迟写：缓冲区的数据不立刻写入磁盘，而是挂在队尾。
3. 优化物理块分布
4. 虚拟盘：利用内存空间仿真磁盘，又称RAM盘。